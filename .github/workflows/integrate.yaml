name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        charm: [activator, autoscaler, controller, webhook]
    steps:
    - uses: actions/checkout@v2
    - run: sudo apt update && sudo apt install tox
    - run: tox -e ${{ matrix.charm }}-lint

  unit:
    name: Unit Test
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        charm: [activator, autoscaler, controller, webhook]
    steps:
    - uses: actions/checkout@v2
    - run: sudo apt update && sudo apt install tox
    - run: tox -e ${{ matrix.charm }}-unit

  integration:
    name: Integration Test
    runs-on: ubuntu-latest

    steps:
    - name: Check out repo
      uses: actions/checkout@v2

    - name: Setup operator environment
      uses: charmed-kubernetes/actions-operator@main
      with:
        provider: microk8s
        channel: 1.21/stable

    - run: sg microk8s -c "microk8s enable ingress metallb:10.64.140.43-10.64.140.49"
    - run: sudo snap install juju-wait --classic
    - run: juju destroy-model --yes --destroy-storage testing
    - run: juju add-model knative-serving

    - name: Run integration tests
      run: tox -vve integration -- --model knative-serving --destructive-mode
      env:
        KUBECONFIG: /home/runner/.kube/config

    - run: kubectl get all -A
      if: failure()

    - run: juju status
      if: failure()
